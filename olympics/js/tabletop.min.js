(function(p){var f=!1;if("undefined"!==typeof module&&module.exports)var f=!0,q=require("request");var g=!1,l=!1;try{"undefined"!==typeof(new XMLHttpRequest).withCredentials?g=!0:"XDomainRequest"in window&&(l=g=!0)}catch(s){}var n=Array.prototype.indexOf,m=function(a,b){var c=0,e=a.length;if(n&&a.indexOf===n)return a.indexOf(b);for(;c<e;c++)if(a[c]===b)return c;return-1},d=function(a){if(!(this&&this instanceof d))return new d(a);"string"===typeof a&&(a={key:a});this.callback=a.callback;this.wanted=
a.wanted||[];this.key=a.key;this.simpleSheet=!!a.simpleSheet;this.parseNumbers=!!a.parseNumbers;this.wait=!!a.wait;this.reverse=!!a.reverse;this.postProcess=a.postProcess;this.debug=!!a.debug;this.query=a.query||"";this.orderby=a.orderby;this.endpoint=a.endpoint||"https://spreadsheets.google.com";this.singleton=!!a.singleton;this.simple_url=!!a.simple_url;this.callbackContext=a.callbackContext;"undefined"!==typeof a.proxy&&(this.endpoint=a.proxy,this.singleton=this.simple_url=!0,g=!1);this.parameterize=
a.parameterize||!1;this.singleton&&("undefined"!==typeof d.singleton&&this.log("WARNING! Tabletop singleton already defined"),d.singleton=this);/key=/.test(this.key)&&(this.log("You passed a key as a URL! Attempting to parse."),this.key=this.key.match("key=(.*?)&")[1]);this.key?(this.log("Initializing with key "+this.key),this.models={},this.model_names=[],this.base_json_path="/feeds/worksheets/"+this.key+"/public/basic?alt=",this.base_json_path=f||g?this.base_json_path+"json":this.base_json_path+
"json-in-script",this.wait||this.fetch()):this.log("You need to pass Tabletop a key!")};d.callbacks={};d.init=function(a){return new d(a)};d.sheets=function(){this.log("Times have changed! You'll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)")};d.prototype={fetch:function(a){"undefined"!==typeof a&&(this.callback=a);this.requestData(this.base_json_path,this.loadSheets)},requestData:function(a,b){if(f)this.serverSideFetch(a,b);else{var c=this.endpoint.split("//").shift()||
"http";!g||l&&c!==location.protocol?this.injectScript(a,b):this.xhrFetch(a,b)}},xhrFetch:function(a,b){var c=l?new XDomainRequest:new XMLHttpRequest;c.open("GET",this.endpoint+a);var e=this;c.onload=function(){try{var a=JSON.parse(c.responseText)}catch(d){console.error(d)}b.call(e,a)};c.send()},injectScript:function(a,b){var c=document.createElement("script"),e;if(this.singleton)b===this.loadSheets?e="Tabletop.singleton.loadSheets":b===this.loadSheet&&(e="Tabletop.singleton.loadSheet");else{var k=
this;e="tt"+ +new Date+Math.floor(1E5*Math.random());d.callbacks[e]=function(){var a=Array.prototype.slice.call(arguments,0);b.apply(k,a);c.parentNode.removeChild(c);delete d.callbacks[e]};e="Tabletop.callbacks."+e}var r=a+"&callback="+e;this.simple_url?-1!==a.indexOf("/list/")?c.src=this.endpoint+"/"+this.key+"-"+a.split("/")[4]:c.src=this.endpoint+"/"+this.key:c.src=this.endpoint+r;this.parameterize&&(c.src=this.parameterize+encodeURIComponent(c.src));document.getElementsByTagName("script")[0].parentNode.appendChild(c)},
serverSideFetch:function(a,b){var c=this;q({url:this.endpoint+a,json:!0},function(a,k,d){if(a)return console.error(a);b.call(c,d)})},isWanted:function(a){return 0===this.wanted.length?!0:-1!==m(this.wanted,a)},data:function(){if(0!==this.model_names.length)return this.simpleSheet?(1<this.model_names.length&&this.debug&&this.log("WARNING You have more than one sheet but are using simple sheet mode! Don't blame me when something goes wrong."),this.models[this.model_names[0]].all()):this.models},addWanted:function(a){-1===
m(this.wanted,a)&&this.wanted.push(a)},loadSheets:function(a){var b,c,e=[];this.foundSheetNames=[];b=0;for(c=a.feed.entry.length;b<c;b++)if(this.foundSheetNames.push(a.feed.entry[b].title.$t),this.isWanted(a.feed.entry[b].content.$t)){var d=a.feed.entry[b].link[3].href.substr(a.feed.entry[b].link[3].href.length-3,3),d="/feeds/list/"+this.key+"/"+d+"/public/values?sq="+this.query+"&alt=",d=f||g?d+"json":d+"json-in-script";this.orderby&&(d+="&orderby=column:"+this.orderby.toLowerCase());this.reverse&&
(d+="&reverse=true");e.push(d)}this.sheetsToLoad=e.length;b=0;for(c=e.length;b<c;b++)this.requestData(e[b],this.loadSheet)},sheets:function(a){if("undefined"===typeof a)return this.models;if("undefined"!==typeof this.models[a])return this.models[a]},loadSheet:function(a){a=new d.Model({data:a,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this});this.models[a.name]=a;-1===m(this.model_names,a.name)&&this.model_names.push(a.name);this.sheetsToLoad--;0===this.sheetsToLoad&&this.doCallback()},
doCallback:function(){0===this.sheetsToLoad&&this.callback.apply(this.callbackContext||this,[this.data(),this])},log:function(a){this.debug&&"undefined"!==typeof console&&"undefined"!==typeof console.log&&Function.prototype.apply.apply(console.log,[console,arguments])}};d.Model=function(a){var b,c,d,k;this.column_names=[];this.name=a.data.feed.title.$t;this.elements=[];this.raw=a.data;if("undefined"===typeof a.data.feed.entry)a.tabletop.log("Missing data for "+this.name+", make sure you didn't forget column headers"),
this.elements=[];else{for(b in a.data.feed.entry[0])/^gsx/.test(b)&&this.column_names.push(b.replace("gsx$",""));b=0;for(d=a.data.feed.entry.length;b<d;b++){var g=a.data.feed.entry[b],h={};c=0;for(k=this.column_names.length;c<k;c++){var f=g["gsx$"+this.column_names[c]];"undefined"!==typeof f?a.parseNumbers&&""!==f.$t&&!isNaN(f.$t)?h[this.column_names[c]]=+f.$t:h[this.column_names[c]]=f.$t:h[this.column_names[c]]=""}void 0===h.rowNumber&&(h.rowNumber=b+1);a.postProcess&&a.postProcess(h);this.elements.push(h)}}};
d.Model.prototype={all:function(){return this.elements},toArray:function(){var a=[],b,c,d,f;b=0;for(d=this.elements.length;b<d;b++){var g=[];c=0;for(f=this.column_names.length;c<f;c++)g.push(this.elements[b][this.column_names[c]]);a.push(g)}return a}};f?module.exports=d:p.Tabletop=d})(this);